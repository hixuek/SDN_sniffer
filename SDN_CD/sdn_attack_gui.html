<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDNåŒ¹é…åŸŸå—…æ¢æ”»å‡»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .topology-container {
            position: relative;
            height: 300px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
            overflow: hidden;
        }

        .topology-svg {
            width: 100%;
            height: 100%;
        }

        .node {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .node:hover {
            transform: scale(1.1);
        }

        .node circle {
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
        }

        .switch { fill: #4299e1; }
        .host { fill: #48bb78; }
        .controller { fill: #ed8936; }

        .link {
            stroke: #a0aec0;
            stroke-width: 3;
            transition: stroke-width 0.3s ease;
        }

        .link:hover {
            stroke-width: 5;
            stroke: #667eea;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f56565, #e53e3e);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-ready { background: #48bb78; }
        .status-running { background: #ed8936; }
        .status-error { background: #f56565; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .log-container {
            height: 200px;
            overflow-y: auto;
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .log-timestamp {
            color: #a0aec0;
            margin-right: 10px;
        }

        .log-info { color: #63b3ed; }
        .log-success { color: #68d391; }
        .log-warning { color: #fbb36b; }
        .log-error { color: #fc8181; }

        .config-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .result-card:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .result-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .rtt-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0;
            transition: width 0.3s ease;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 10px 20px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”’ SDNåŒ¹é…åŸŸå—…æ¢æ”»å‡»</h1>
            <p>è½¯ä»¶å®šä¹‰ç½‘ç»œè¯¾ç¨‹è®¾è®¡ </p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('topology')">ç½‘ç»œæ‹“æ‰‘</button>
            <button class="tab" onclick="showTab('attack')">æ”»å‡»é…ç½®</button>
            <button class="tab" onclick="showTab('results')">å®éªŒç»“æœ</button>
            <button class="tab" onclick="showTab('analysis')">å®‰å…¨åˆ†æ</button>
        </div>

        <div id="topology" class="tab-content active">
            <div class="main-grid">
                <div class="card">
                    <h3><span class="icon">ğŸŒ</span>ç½‘ç»œæ‹“æ‰‘ç»“æ„</h3>
                    <div class="topology-container">
                        <svg class="topology-svg" viewBox="0 0 400 250">
                            <!-- äº¤æ¢æœº -->
                            <g class="node switch" data-name="s1">
                                <circle cx="100" cy="125" r="25" class="switch"/>
                                <text x="100" y="130" text-anchor="middle" fill="white" font-weight="bold">S1</text>
                                <text x="100" y="160" text-anchor="middle" font-size="12" fill="#666">äº¤æ¢æœº1</text>
                            </g>
                            <g class="node switch" data-name="s2">
                                <circle cx="300" cy="125" r="25" class="switch"/>
                                <text x="300" y="130" text-anchor="middle" fill="white" font-weight="bold">S2</text>
                                <text x="300" y="160" text-anchor="middle" font-size="12" fill="#666">äº¤æ¢æœº2</text>
                            </g>
                            
                            <!-- æ§åˆ¶å™¨ -->
                            <g class="node controller" data-name="c1">
                                <circle cx="200" cy="50" r="20" class="controller"/>
                                <text x="200" y="55" text-anchor="middle" fill="white" font-weight="bold">C1</text>
                                <text x="200" y="25" text-anchor="middle" font-size="12" fill="#666">æ§åˆ¶å™¨</text>
                            </g>
                            
                            <!-- ä¸»æœº -->
                            <g class="node host" data-name="h1">
                                <circle cx="50" cy="75" r="15" class="host"/>
                                <text x="50" y="80" text-anchor="middle" fill="white" font-size="10">H1</text>
                                <text x="50" y="100" text-anchor="middle" font-size="10" fill="#666">10.0.0.1</text>
                            </g>
                            <g class="node host" data-name="h2">
                                <circle cx="50" cy="175" r="15" class="host"/>
                                <text x="50" y="180" text-anchor="middle" fill="white" font-size="10">H2</text>
                                <text x="50" y="200" text-anchor="middle" font-size="10" fill="#666">10.0.0.2</text>
                            </g>
                            <g class="node host" data-name="h3">
                                <circle cx="350" cy="75" r="15" class="host"/>
                                <text x="350" y="80" text-anchor="middle" fill="white" font-size="10">H3</text>
                                <text x="350" y="100" text-anchor="middle" font-size="10" fill="#666">10.0.0.3</text>
                            </g>
                            <g class="node host" data-name="h4">
                                <circle cx="350" cy="175" r="15" class="host"/>
                                <text x="350" y="180" text-anchor="middle" fill="white" font-size="10">H4</text>
                                <text x="350" y="200" text-anchor="middle" font-size="10" fill="#666">10.0.0.4</text>
                            </g>
                            
                            <!-- è¿æ¥çº¿ -->
                            <line class="link" x1="75" y1="75" x2="75" y2="125"/>
                            <line class="link" x1="75" y1="175" x2="75" y2="125"/>
                            <line class="link" x1="325" y1="75" x2="325" y2="125"/>
                            <line class="link" x1="325" y1="175" x2="325" y2="125"/>
                            <line class="link" x1="125" y1="125" x2="275" y2="125"/>
                            <line class="link" x1="180" y1="70" x2="120" y2="105"/>
                            <line class="link" x1="220" y1="70" x2="280" y2="105"/>
                        </svg>
                    </div>
                </div>

                <div class="card">
                    <h3><span class="icon">âš™ï¸</span>å®éªŒæ§åˆ¶é¢æ¿</h3>
                    <div class="control-panel" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="startTopology()">
                            <span class="status-indicator status-ready" id="topo-status"></span>
                            å¯åŠ¨æ‹“æ‰‘
                        </button>
                        <button class="btn btn-primary" onclick="configFlows()">é…ç½®æµè¡¨</button>
                        <button class="btn btn-warning" onclick="testConnectivity()">è¿é€šæ€§æµ‹è¯•</button>
                        <button class="btn btn-danger" onclick="stopTopology()">åœæ­¢å®éªŒ</button>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress"></div>
                    </div>
                </div>
            </div>

            <div class="card full-width">
                <h3><span class="icon">ğŸ“‹</span>å®éªŒæ—¥å¿—</h3>
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">
                        <span class="log-timestamp">[00:00:00]</span>
                        ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ...
                    </div>
                </div>
            </div>
        </div>

        <div id="attack" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <h3><span class="icon">ğŸ¯</span>æ”»å‡»é…ç½®</h3>
                    <div class="config-panel">
                        <div class="form-group">
                            <label class="form-label">æºIPåœ°å€</label>
                            <input type="text" class="form-input" value="10.0.0.1" id="srcIP">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç›®æ ‡IPåœ°å€</label>
                            <input type="text" class="form-input" value="10.0.0.2" id="dstIP">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ¢æµ‹åŒ…æ•°é‡</label>
                            <input type="number" class="form-input" value="10" id="packetCount">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ¢æµ‹é—´éš”(ms)</label>
                            <input type="number" class="form-input" value="100" id="interval">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3><span class="icon">ğŸ”</span>æµè¡¨åŒ¹é…åŸŸé€‰æ‹©</h3>
                    <div class="form-group">
                        <label><input type="checkbox" class="field-checkbox" value="eth_src" checked> Ethernetæºåœ°å€</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="eth_dst" checked> Ethernetç›®æ ‡åœ°å€</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="ip_src" checked> IPæºåœ°å€</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="ip_dst" checked> IPç›®æ ‡åœ°å€</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="tcp_src" checked> TCPæºç«¯å£</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="tcp_dst" checked> TCPç›®æ ‡ç«¯å£</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="ip_proto"> IPåè®®ç±»å‹</label>
                    </div>
                </div>
            </div>

            <div class="card full-width">
                <h3><span class="icon">ğŸš€</span>æ”»å‡»æ‰§è¡Œ</h3>
                <div class="control-panel">
                    <button class="btn btn-primary" onclick="startAttack()">å¼€å§‹å—…æ¢</button>
                    <button class="btn btn-warning" onclick="pauseAttack()">æš‚åœå—…æ¢</button>
                    <button class="btn btn-danger" onclick="stopAttack()">åœæ­¢å—…æ¢</button>
                    <button class="btn btn-success" onclick="exportResults()">å¯¼å‡ºç»“æœ</button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="attackProgress"></div>
                </div>
            </div>
        </div>

        <div id="results" class="tab-content">
            <div class="card full-width">
                <h3><span class="icon">ğŸ“Š</span>RTTæµ‹é‡ç»“æœ</h3>
                <div class="results-grid" id="resultsGrid">
                    <!-- ç»“æœå°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="card full-width">
                <h3><span class="icon">ğŸ“ˆ</span>RTTè¶‹åŠ¿å›¾</h3>
                <canvas id="rttChart" width="800" height="300" style="max-width: 100%;"></canvas>
            </div>
        </div>

        <div id="analysis" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <h3><span class="icon">ğŸ”’</span>å®‰å…¨åˆ†æ</h3>
                    <div id="securityAnalysis">
                        <h4>æ£€æµ‹åˆ°çš„åŒ¹é…åŸŸï¼š</h4>
                        <ul id="detectedFields"></ul>
                        
                        <h4>å®‰å…¨é£é™©è¯„ä¼°ï¼š</h4>
                        <div id="riskAssessment"></div>
                        
                        <h4>å»ºè®®é˜²æŠ¤æªæ–½ï¼š</h4>
                        <ul id="recommendations"></ul>
                    </div>
                </div>

                <div class="card">
                    <h3><span class="icon">ğŸ“‹</span>å®éªŒæŠ¥å‘Š</h3>
                    <div class="form-group">
                        <label class="form-label">æŠ¥å‘Šæ ¼å¼</label>
                        <select class="form-input" id="reportFormat">
                            <option value="html">HTMLæŠ¥å‘Š</option>
                            <option value="json">JSONæ•°æ®</option>
                        </select>
                        <p class="form-help">HTMLæŠ¥å‘ŠåŒ…å«å›¾è¡¨å’Œå®Œæ•´åˆ†æï¼ŒJSONæ•°æ®é€‚åˆè¿›ä¸€æ­¥å¤„ç†</p>
                    </div>
                    <button class="btn btn-primary full-width" onclick="generateReport()">
                        <span class="icon">ğŸ“¥</span> ç”Ÿæˆå¹¶ä¸‹è½½æŠ¥å‘Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let experimentState = {
            topologyRunning: false,
            attackRunning: false,
            results: {},
            logs: []
        };

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            event.target.classList.add('active');
            document.getElementById(tabName).style.display = 'block';
            if(tabName === 'results') {
                showResultCharts(experimentState.results);
            } else if(tabName === 'analysis') {
                analyzeResults(experimentState.results);
            }
        }

        // æ—¥å¿—è®°å½•
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span>${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ‹“æ‰‘ç®¡ç†
        function startTopology() {
            if (experimentState.topologyRunning) return;
            
            addLog('æ­£åœ¨å¯åŠ¨SDNæ‹“æ‰‘ç»“æ„...', 'info');
            updateProgress('progress', 0);
            
            // ä¸åç«¯APIé€šä¿¡
            fetch('http://localhost:5000/api/start_topology', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('æ‹“æ‰‘å¯åŠ¨å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                addLog('æ‹“æ‰‘å¯åŠ¨æˆåŠŸï¼', 'success');
                experimentState.topologyRunning = true;
                document.getElementById('topo-status').className = 'status-indicator status-running';
                updateProgress('progress', 100);
            })
            .catch(error => {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
                updateProgress('progress', 0);
            });
        }

        function configFlows() {
            if (!experimentState.topologyRunning) {
                addLog('è¯·å…ˆå¯åŠ¨æ‹“æ‰‘ç»“æ„', 'error');
                return;
            }
            addLog('é…ç½®æµè¡¨è§„åˆ™...', 'info');
            // åŠ¨æ€æ”¶é›†å‹¾é€‰çš„åŒ¹é…åŸŸ
            const checkedFields = Array.from(document.querySelectorAll('.field-checkbox:checked')).map(cb => cb.value);
            if (checkedFields.length === 0) {
                addLog('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæµè¡¨åŒ¹é…åŸŸ', 'error');
                return;
            }
            fetch('http://localhost:5000/api/config_flows', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'fields': checkedFields
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('æµè¡¨é…ç½®å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                addLog('æµè¡¨è§„åˆ™å·²é…ç½®', 'success');
            })
            .catch(error => {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
            });
        }

        function testConnectivity() {
            if (!experimentState.topologyRunning) {
                addLog('è¯·å…ˆå¯åŠ¨æ‹“æ‰‘ç»“æ„', 'error');
                return;
            }
            
            addLog('æ‰§è¡Œè¿é€šæ€§æµ‹è¯•...', 'info');
            
            fetch('http://localhost:5000/api/test_connectivity', {
                method: 'GET'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è¿é€šæ€§æµ‹è¯•å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                if (data.results) {
                    // å¤„ç†å­—å…¸ç±»å‹çš„ç»“æœ
                    Object.keys(data.results).forEach(key => {
                        const rtt = data.results[key];
                        const [src, dst] = key.split('->');
                        if (rtt > 0) {
                            addLog(`${src} -> ${dst}: è¿é€šæ­£å¸¸ (${rtt.toFixed(2)}ms)`, 'success');
                        } else {
                            addLog(`${src} -> ${dst}: è¿é€šå¤±è´¥`, 'error');
                        }
                    });
                    addLog('è¿é€šæ€§æµ‹è¯•å®Œæˆ', 'success');
                }
            })
            .catch(error => {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
            });
        }

        function stopTopology() {
            if (!experimentState.topologyRunning) return;
            
            addLog('æ­£åœ¨åœæ­¢æ‹“æ‰‘...', 'warning');
            
            fetch('http://localhost:5000/api/stop_topology', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('æ‹“æ‰‘åœæ­¢å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                experimentState.topologyRunning = false;
                document.getElementById('topo-status').className = 'status-indicator status-ready';
                updateProgress('progress', 0);
                addLog('æ‹“æ‰‘å·²åœæ­¢', 'info');
            })
            .catch(error => {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
            });
        }

        // æ”»å‡»æ¨¡æ‹Ÿ
        function startAttack() {
            if (!experimentState.topologyRunning) {
                addLog('è¯·å…ˆå¯åŠ¨æ‹“æ‰‘ç»“æ„', 'error');
                return;
            }
            if (experimentState.attackRunning) return;
            // åŠ¨æ€æ”¶é›†å‹¾é€‰çš„åŒ¹é…åŸŸ
            const checkedFields = Array.from(document.querySelectorAll('.field-checkbox:checked')).map(cb => cb.value);
            if (checkedFields.length === 0) {
                addLog('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæµè¡¨åŒ¹é…åŸŸ', 'error');
                return;
            }
            addLog('å¼€å§‹æ‰§è¡ŒåŒ¹é…åŸŸå—…æ¢æ”»å‡»...', 'warning');
            fetch('http://localhost:5000/api/start_attack', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'fields': checkedFields
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('æ”»å‡»å¯åŠ¨å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                experimentState.attackRunning = true;
                addLog('æ”»å‡»å·²å¯åŠ¨ï¼Œæ­£åœ¨æ”¶é›†æ•°æ®...', 'info');
                checkAttackStatus();
            })
            .catch(error => {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
            });
        }

        function checkAttackStatus() {
            fetch('http://localhost:5000/api/attack_status')
                .then(response => response.json())
                .then(data => {
                    if (data.completed) {
                        experimentState.attackRunning = false;
                        experimentState.results = data.results || {};
                        addLog('æ”»å‡»å®Œæˆï¼Œæ­£åœ¨å±•ç¤ºç»“æœ...', 'success');
                        showTab('results');
                        showResultCharts(experimentState.results);
                        analyzeResults(experimentState.results);
                    } else {
                        setTimeout(checkAttackStatus, 2000);  // ç»§ç»­è½®è¯¢
                    }
                });
        }

        function generateResults() {
            addLog('æ­£åœ¨ç”Ÿæˆå®éªŒæŠ¥å‘Š...', 'info');
            
            fetch('http://localhost:5000/api/generate_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                addLog('å®éªŒæŠ¥å‘Šç”ŸæˆæˆåŠŸ', 'success');
                
                if (data.report_url) {
                    const reportLink = document.getElementById('report-link');
                    reportLink.href = data.report_url;
                    reportLink.style.display = 'inline-block';
                }
                
                // æ˜¾ç¤ºç»“æœå›¾è¡¨
                showResultCharts(data.results);
                
                // å®‰å…¨åˆ†æ
                analyzeResults(data.results);
            })
            .catch(error => {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
            });
        }

        function analyzeResults(results) {
            const detectedFields = document.getElementById('detectedFields');
            const riskAssessment = document.getElementById('riskAssessment');
            const recommendations = document.getElementById('recommendations');
            
            detectedFields.innerHTML = '';
            
            // ä½¿ç”¨ä¼ å…¥çš„ç»“æœæ•°æ®æˆ–é»˜è®¤ä½¿ç”¨å®éªŒçŠ¶æ€ä¸­çš„ç»“æœ
            const resultsData = results || experimentState.results;
            const allAvg = Object.values(resultsData).map(d => d.avgRTT);
            const globalAvg = allAvg.length > 0 ? allAvg.reduce((a, b) => a + b, 0) / allAvg.length : 0;
            let detected = [];
            for (const [field, data] of Object.entries(resultsData)) {
                let reasons = [];
                if (data.variance > 1.0) reasons.push(`æ–¹å·®${data.variance.toFixed(2)}ms > 1.0ms`);
                if (data.avgRTT > globalAvg * 1.5) reasons.push(`å‡å€¼${data.avgRTT.toFixed(2)}ms > å…¨éƒ¨å‡å€¼çš„1.5å€(${(globalAvg*1.5).toFixed(2)}ms)`);
                if ((data.maxRTT - data.minRTT) > 5.0) reasons.push(`æå·®${(data.maxRTT-data.minRTT).toFixed(2)}ms > 5ms`);
                if (reasons.length > 0) {
                    const li = document.createElement('li');
                    li.textContent = `${field}: æ£€æµ‹ä¸ºåŒ¹é…åŸŸï¼ˆ${reasons.join('ï¼Œ')}ï¼‰`;
                    detectedFields.appendChild(li);
                    detected.push(field);
                }
            }
            let riskLevel = '';
            let riskDesc = '';
            if (detected.length >= 3) {
                riskLevel = '<div style="color: #e53e3e; font-weight: bold;">é«˜é£é™©</div>';
                riskDesc = 'æ£€æµ‹åˆ°å¤šä¸ªåŒ¹é…åŸŸå­˜åœ¨å¯è¯†åˆ«çš„RTTå·®å¼‚ï¼Œæ”»å‡»è€…å¯èƒ½é€šè¿‡æ­¤æ–¹æ³•æ¨æ–­ç½‘ç»œæµè¡¨é…ç½®ã€‚';
            } else if (detected.length >= 1) {
                riskLevel = '<div style="color: #f6ad55; font-weight: bold;">ä¸­é£é™©</div>';
                riskDesc = 'æ£€æµ‹åˆ°éƒ¨åˆ†åŒ¹é…åŸŸå­˜åœ¨å¯è¯†åˆ«çš„RTTå·®å¼‚ï¼Œæ”»å‡»è€…å¯èƒ½æ¨æ–­éƒ¨åˆ†æµè¡¨é…ç½®ã€‚';
            } else {
                riskLevel = '<div style="color: #48bb78; font-weight: bold;">ä½é£é™©</div>';
                riskDesc = 'æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„åŒ¹é…åŸŸRTTå·®å¼‚ï¼Œå½“å‰æµè¡¨é…ç½®ç›¸å¯¹å®‰å…¨ã€‚';
            }
            riskAssessment.innerHTML = `
                ${riskLevel}
                <p>${riskDesc}</p>
            `;
            recommendations.innerHTML = `
                <li>å®æ–½ç»Ÿä¸€çš„æ•°æ®åŒ…å¤„ç†æ—¶é—´</li>
                <li>æ·»åŠ éšæœºå»¶è¿Ÿä»¥æ··æ·†RTTæ¨¡å¼</li>
                <li>ç›‘æ§å¼‚å¸¸æ¢æµ‹è¡Œä¸º</li>
                <li>é™åˆ¶å•ä¸ªæºçš„æ¢æµ‹é¢‘ç‡</li>
                <li>ä½¿ç”¨åŠ å¯†é€šé“ä¿æŠ¤æ§åˆ¶ä¿¡æ¯</li>
            `;
        }

        function updateProgress(elementId, percent) {
            document.getElementById(elementId).style.width = percent + '%';
        }

        function showResultCharts(results) {
            const resultsContainer = document.getElementById('resultsGrid');
            resultsContainer.innerHTML = '';
            const allFields = ['eth_src', 'eth_dst', 'ip_src', 'ip_dst', 'tcp_src', 'tcp_dst', 'ip_proto'];
            const resultsData = results || experimentState.results;

            for (const field of allFields) {
                const data = resultsData[field];
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                if (data) {
                    resultCard.innerHTML = `
                        <div class="result-title">${field.toUpperCase()}</div>
                        <div class="rtt-value">${data.avgRTT.toFixed(2)}ms</div>
                        <div>èŒƒå›´: ${data.minRTT.toFixed(2)}ms - ${data.maxRTT.toFixed(2)}ms</div>
                        <div>å˜åŒ–: ${data.variance.toFixed(2)}ms</div>
                    `;
                } else {
                    resultCard.innerHTML = `
                        <div class="result-title">${field.toUpperCase()}</div>
                        <div class="rtt-value">--</div>
                        <div>èŒƒå›´: --</div>
                        <div>å˜åŒ–: --</div>
                    `;
                }
                resultsContainer.appendChild(resultCard);
            }
        }
        
        function pauseAttack() {
            if (experimentState.attackRunning) {
                fetch('http://localhost:5000/api/stop_attack', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'pause': true
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('æš‚åœæ”»å‡»å¤±è´¥');
                    }
                    return response.json();
                })
                .then(data => {
                    experimentState.attackRunning = false;
                    addLog('æ”»å‡»å·²æš‚åœ', 'warning');
                })
                .catch(error => {
                    addLog(`é”™è¯¯: ${error.message}`, 'error');
                });
            }
        }

        function stopAttack() {
            if (!experimentState.attackRunning) return;
            
            fetch('http://localhost:5000/api/stop_attack', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('åœæ­¢æ”»å‡»å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                experimentState.attackRunning = false;
                updateProgress('attackProgress', 0);
                addLog('æ”»å‡»å·²åœæ­¢', 'info');
            })
            .catch(error => {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
            });
        }

        function exportResults() {
            fetch('http://localhost:5000/api/export_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('å¯¼å‡ºç»“æœå¤±è´¥');
                }
                return response.json(); // å…ˆæ‹¿åˆ°JSON
            })
            .then(data => {
                if (!data.download_url) {
                    throw new Error('æœåŠ¡å™¨æœªè¿”å›ä¸‹è½½åœ°å€');
                }
                // ç¬¬äºŒæ­¥ï¼šfetchä¸‹è½½æ–‡ä»¶
                fetch(`http://localhost:5000${data.download_url}`)
                    .then(res => res.blob())
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.filename || 'sdn_attack_results.json';
                        a.click();
                        URL.revokeObjectURL(url);
                        addLog('å®éªŒç»“æœå·²å¯¼å‡º', 'success');
                    });
            })
            .catch(error => {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
            });
        }

        function generateReport() {
            addLog('æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...', 'info');
            
            // è·å–é€‰æ‹©çš„æŠ¥å‘Šæ ¼å¼
            const formatSelect = document.querySelector('#reportFormat');
            const format = formatSelect ? formatSelect.value.toLowerCase().replace('æŠ¥å‘Š', '').replace('æ•°æ®', '') : 'html';
            
            fetch('http://localhost:5000/api/generate_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    format: format
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                if (!data.download_url) {
                    throw new Error('æœåŠ¡å™¨æœªè¿”å›ä¸‹è½½åœ°å€');
                }
                
                // ä¸‹è½½æ–‡ä»¶
                fetch(`http://localhost:5000${data.download_url}`)
                    .then(res => res.blob())
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.filename || 'sdn_security_report.html';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        addLog('æŠ¥å‘Šç”Ÿæˆå¹¶ä¸‹è½½æˆåŠŸ', 'success');
                    });
            })
            .catch(error => {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
            });
        }

        // ç½‘ç»œèŠ‚ç‚¹äº¤äº’
        document.addEventListener('DOMContentLoaded', function() {
            const nodes = document.querySelectorAll('.node');
            nodes.forEach(node => {
                node.addEventListener('click', function() {
                    const nodeName = this.getAttribute('data-name');
                    showNodeInfo(nodeName);
                });
            });
        });

        function showNodeInfo(nodeName) {
            const nodeInfo = {
                's1': {
                    type: 'äº¤æ¢æœº',
                    ip: 'ç®¡ç†IP: 192.168.1.10',
                    ports: 'ç«¯å£: 4ä¸ª',
                    flows: 'æµè¡¨è§„åˆ™: åŸºäºæºIPåŒ¹é…'
                },
                's2': {
                    type: 'äº¤æ¢æœº',
                    ip: 'ç®¡ç†IP: 192.168.1.11',
                    ports: 'ç«¯å£: 4ä¸ª',
                    flows: 'æµè¡¨è§„åˆ™: åŸºäºç›®æ ‡ç«¯å£åŒ¹é…'
                },
                'c1': {
                    type: 'OpenFlowæ§åˆ¶å™¨',
                    ip: 'æ§åˆ¶IP: 192.168.1.1',
                    version: 'OpenFlow 1.3',
                    status: 'è¿è¡Œä¸­'
                },
                'h1': {
                    type: 'ä¸»æœº',
                    ip: 'IP: 10.0.0.1',
                    mac: 'MAC: 00:00:00:00:00:01',
                    role: 'æ”»å‡»æº'
                },
                'h2': {
                    type: 'ä¸»æœº',
                    ip: 'IP: 10.0.0.2',
                    mac: 'MAC: 00:00:00:00:00:02',
                    role: 'æ”»å‡»ç›®æ ‡'
                },
                'h3': {
                    type: 'ä¸»æœº',
                    ip: 'IP: 10.0.0.3',
                    mac: 'MAC: 00:00:00:00:00:03',
                    role: 'è§‚å¯ŸèŠ‚ç‚¹'
                },
                'h4': {
                    type: 'ä¸»æœº',
                    ip: 'IP: 10.0.0.4',
                    mac: 'MAC: 00:00:00:00:00:04',
                    role: 'è§‚å¯ŸèŠ‚ç‚¹'
                }
            };
            
            const info = nodeInfo[nodeName];
            if (info) {
                addLog(`èŠ‚ç‚¹ä¿¡æ¯ - ${nodeName.toUpperCase()}: ${info.type}, ${info.ip || info.mac}`, 'info');
            }
        }

        // RTTå›¾è¡¨ç»˜åˆ¶
        function drawRTTChart() {
            const canvas = document.getElementById('rttChart');
            const ctx = canvas.getContext('2d');
            const allFields = ['eth_src', 'eth_dst', 'ip_src', 'ip_dst', 'tcp_src', 'tcp_dst', 'ip_proto'];
            const resultsData = experimentState.results;

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // æ²¡æœ‰ä»»ä½•æ•°æ®
            if (Object.keys(resultsData).length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®ï¼Œè¯·å…ˆæ‰§è¡Œæ”»å‡»', canvas.width/2, canvas.height/2);
                return;
            }

            // ç»„è£…æ‰€æœ‰æŸ±å­æ•°æ®
            let bars = [];
            let maxRTT = 0;
            allFields.forEach((field, idx) => {
                const data = resultsData[field];
                if (data && data.samples.length > 0) {
                    data.samples.forEach((rtt, i) => {
                        bars.push({
                            field,
                            idx,
                            rtt,
                            sampleIdx: i
                        });
                        if (rtt > maxRTT) maxRTT = rtt;
                    });
                }
            });
            if (maxRTT === 0) maxRTT = 1;

            // æŸ±çŠ¶å›¾å‚æ•°
            const barWidth = Math.max(8, (canvas.width - 100) / bars.length - 2);
            const colors = ['#667eea', '#e53e3e', '#38a169', '#f6ad55', '#3182ce', '#d53f8c', '#319795'];

            // åæ ‡è½´
            ctx.strokeStyle = '#888';
            ctx.lineWidth = 1;
                ctx.beginPath();
            ctx.moveTo(60, 20);
            ctx.lineTo(60, canvas.height - 40);
            ctx.lineTo(canvas.width - 20, canvas.height - 40);
                ctx.stroke();

            // Yè½´åˆ»åº¦
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            for (let i = 0; i <= 5; i++) {
                const y = canvas.height - 40 - (canvas.height - 80) * (i / 5);
                const rttVal = (maxRTT * i / 5).toFixed(0);
                ctx.fillText(rttVal + 'ms', 10, y + 4);
            }

            // ç”»æŸ±å­
            bars.forEach((bar, i) => {
                const x = 60 + i * (barWidth + 2);
                const y = canvas.height - 40 - (canvas.height - 80) * (bar.rtt / maxRTT);
                const h = (canvas.height - 40) - y;
                ctx.fillStyle = colors[bar.idx % colors.length];
                ctx.fillRect(x, y, barWidth, h);

                // æ¨ªè½´æ ‡ç­¾ï¼ˆåªç”»ç¬¬ä¸€ä¸ªæ ·æœ¬æ—¶çš„å­—æ®µåï¼‰
                if (bar.sampleIdx === 0) {
                    ctx.save();
                    ctx.translate(x + barWidth / 2, canvas.height - 25);
                    ctx.rotate(-Math.PI / 4);
                    ctx.textAlign = 'right';
                    ctx.fillStyle = colors[bar.idx % colors.length];
                    ctx.font = '12px Arial';
                    ctx.fillText(bar.field.toUpperCase(), 0, 0);
                    ctx.restore();
                }
            });

            // å›¾ä¾‹
            allFields.forEach((field, idx) => {
                ctx.fillStyle = colors[idx % colors.length];
                ctx.fillRect(canvas.width - 110, 30 + idx * 18, 14, 14);
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.fillText(field.toUpperCase(), canvas.width - 90, 42 + idx * 18);
            });
        }

        // å®æ—¶æ›´æ–°å›¾è¡¨
        setInterval(() => {
            if (document.getElementById('results').style.display !== 'none') {
                drawRTTChart();
            }
        }, 1000);

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey) {
                switch(event.key) {
                    case '1':
                        event.preventDefault();
                        showTab('topology');
                        break;
                    case '2':
                        event.preventDefault();
                        showTab('attack');
                        break;
                    case '3':
                        event.preventDefault();
                        showTab('results');
                        break;
                    case '4':
                        event.preventDefault();
                        showTab('analysis');
                        break;
                    case 's':
                        event.preventDefault();
                        if (experimentState.topologyRunning) {
                            startAttack();
                        } else {
                            startTopology();
                        }
                        break;
                }
            }
        });

        // åˆå§‹åŒ–æç¤º
        addLog('SDNåŒ¹é…åŸŸå—…æ¢æ”»å‡»å®éªŒå¹³å°å·²å°±ç»ª', 'success');
        addLog('å¿«æ·é”®: Ctrl+1-4 åˆ‡æ¢æ ‡ç­¾é¡µ, Ctrl+S å¼€å§‹', 'info');
        addLog('è½¯ä»¶å®šä¹‰ç½‘ç»œè¯¾ç¨‹è®¾è®¡', 'warning');
    </script>
</body>
</html>