<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDNÂåπÈÖçÂüüÂóÖÊé¢ÊîªÂáª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .topology-container {
            position: relative;
            height: 300px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
            overflow: hidden;
        }

        .topology-svg {
            width: 100%;
            height: 100%;
        }

        .node {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .node:hover {
            transform: scale(1.1);
        }

        .node circle {
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
        }

        .switch { fill: #4299e1; }
        .host { fill: #48bb78; }
        .controller { fill: #ed8936; }

        .link {
            stroke: #a0aec0;
            stroke-width: 3;
            transition: stroke-width 0.3s ease;
        }

        .link:hover {
            stroke-width: 5;
            stroke: #667eea;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f56565, #e53e3e);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-ready { background: #48bb78; }
        .status-running { background: #ed8936; }
        .status-error { background: #f56565; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .log-container {
            height: 200px;
            overflow-y: auto;
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .log-timestamp {
            color: #a0aec0;
            margin-right: 10px;
        }

        .log-info { color: #63b3ed; }
        .log-success { color: #68d391; }
        .log-warning { color: #fbb36b; }
        .log-error { color: #fc8181; }

        .config-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .result-card:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .result-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .rtt-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0;
            transition: width 0.3s ease;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 10px 20px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí SDNÂåπÈÖçÂüüÂóÖÊé¢ÊîªÂáª</h1>
            <p>ËΩØ‰ª∂ÂÆö‰πâÁΩëÁªúËØæÁ®ãËÆæËÆ° </p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('topology')">ÁΩëÁªúÊãìÊâë</button>
            <button class="tab" onclick="showTab('attack')">ÊîªÂáªÈÖçÁΩÆ</button>
            <button class="tab" onclick="showTab('results')">ÂÆûÈ™åÁªìÊûú</button>
            <button class="tab" onclick="showTab('analysis')">ÂÆâÂÖ®ÂàÜÊûê</button>
        </div>

        <div id="topology" class="tab-content active">
            <div class="main-grid">
                <div class="card">
                    <h3><span class="icon">üåê</span>ÁΩëÁªúÊãìÊâëÁªìÊûÑ</h3>
                    <div class="topology-container">
                        <svg class="topology-svg" viewBox="0 0 400 250">
                            <!-- ‰∫§Êç¢Êú∫ -->
                            <g class="node switch" data-name="s1">
                                <circle cx="100" cy="125" r="25" class="switch"/>
                                <text x="100" y="130" text-anchor="middle" fill="white" font-weight="bold">S1</text>
                                <text x="100" y="160" text-anchor="middle" font-size="12" fill="#666">‰∫§Êç¢Êú∫1</text>
                            </g>
                            <g class="node switch" data-name="s2">
                                <circle cx="300" cy="125" r="25" class="switch"/>
                                <text x="300" y="130" text-anchor="middle" fill="white" font-weight="bold">S2</text>
                                <text x="300" y="160" text-anchor="middle" font-size="12" fill="#666">‰∫§Êç¢Êú∫2</text>
                            </g>
                            
                            <!-- ÊéßÂà∂Âô® -->
                            <g class="node controller" data-name="c1">
                                <circle cx="200" cy="50" r="20" class="controller"/>
                                <text x="200" y="55" text-anchor="middle" fill="white" font-weight="bold">C1</text>
                                <text x="200" y="25" text-anchor="middle" font-size="12" fill="#666">ÊéßÂà∂Âô®</text>
                            </g>
                            
                            <!-- ‰∏ªÊú∫ -->
                            <g class="node host" data-name="h1">
                                <circle cx="50" cy="75" r="15" class="host"/>
                                <text x="50" y="80" text-anchor="middle" fill="white" font-size="10">H1</text>
                                <text x="50" y="100" text-anchor="middle" font-size="10" fill="#666">10.0.0.1</text>
                            </g>
                            <g class="node host" data-name="h2">
                                <circle cx="50" cy="175" r="15" class="host"/>
                                <text x="50" y="180" text-anchor="middle" fill="white" font-size="10">H2</text>
                                <text x="50" y="200" text-anchor="middle" font-size="10" fill="#666">10.0.0.2</text>
                            </g>
                            <g class="node host" data-name="h3">
                                <circle cx="350" cy="75" r="15" class="host"/>
                                <text x="350" y="80" text-anchor="middle" fill="white" font-size="10">H3</text>
                                <text x="350" y="100" text-anchor="middle" font-size="10" fill="#666">10.0.0.3</text>
                            </g>
                            <g class="node host" data-name="h4">
                                <circle cx="350" cy="175" r="15" class="host"/>
                                <text x="350" y="180" text-anchor="middle" fill="white" font-size="10">H4</text>
                                <text x="350" y="200" text-anchor="middle" font-size="10" fill="#666">10.0.0.4</text>
                            </g>
                            
                            <!-- ËøûÊé•Á∫ø -->
                            <line class="link" x1="75" y1="75" x2="75" y2="125"/>
                            <line class="link" x1="75" y1="175" x2="75" y2="125"/>
                            <line class="link" x1="325" y1="75" x2="325" y2="125"/>
                            <line class="link" x1="325" y1="175" x2="325" y2="125"/>
                            <line class="link" x1="125" y1="125" x2="275" y2="125"/>
                            <line class="link" x1="180" y1="70" x2="120" y2="105"/>
                            <line class="link" x1="220" y1="70" x2="280" y2="105"/>
                        </svg>
                    </div>
                </div>

                <div class="card">
                    <h3><span class="icon">‚öôÔ∏è</span>ÂÆûÈ™åÊéßÂà∂Èù¢Êùø</h3>
                    <div class="control-panel" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="startTopology()">
                            <span class="status-indicator status-ready" id="topo-status"></span>
                            ÂêØÂä®ÊãìÊâë
                        </button>
                        <button class="btn btn-primary" onclick="configFlows()">ÈÖçÁΩÆÊµÅË°®</button>
                        <button class="btn btn-warning" onclick="testConnectivity()">ËøûÈÄöÊÄßÊµãËØï</button>
                        <button class="btn btn-danger" onclick="stopTopology()">ÂÅúÊ≠¢ÂÆûÈ™å</button>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress"></div>
                    </div>
                </div>
            </div>

            <div class="card full-width">
                <h3><span class="icon">üìã</span>ÂÆûÈ™åÊó•Âøó</h3>
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">
                        <span class="log-timestamp">[00:00:00]</span>
                        Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàêÔºåÁ≠âÂæÖÁî®Êà∑Êìç‰Ωú...
                    </div>
                </div>
            </div>
        </div>

        <div id="attack" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <h3><span class="icon">üéØ</span>ÊîªÂáªÈÖçÁΩÆ</h3>
                    <div class="config-panel">
                        <div class="form-group">
                            <label class="form-label">Ê∫êIPÂú∞ÂùÄ</label>
                            <input type="text" class="form-input" value="10.0.0.1" id="srcIP">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÁõÆÊ†áIPÂú∞ÂùÄ</label>
                            <input type="text" class="form-input" value="10.0.0.2" id="dstIP">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Êé¢ÊµãÂåÖÊï∞Èáè</label>
                            <input type="number" class="form-input" value="10" id="packetCount">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Êé¢ÊµãÈó¥Èöî(ms)</label>
                            <input type="number" class="form-input" value="100" id="interval">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3><span class="icon">üîç</span>ÊµÅË°®ÂåπÈÖçÂüüÈÄâÊã©</h3>
                    <div class="form-group">
                        <label><input type="checkbox" class="field-checkbox" value="eth_src" checked> EthernetÊ∫êÂú∞ÂùÄ</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="eth_dst" checked> EthernetÁõÆÊ†áÂú∞ÂùÄ</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="ip_src" checked> IPÊ∫êÂú∞ÂùÄ</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="ip_dst" checked> IPÁõÆÊ†áÂú∞ÂùÄ</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="tcp_src" checked> TCPÊ∫êÁ´ØÂè£</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="tcp_dst" checked> TCPÁõÆÊ†áÁ´ØÂè£</label><br>
                        <label><input type="checkbox" class="field-checkbox" value="ip_proto"> IPÂçèËÆÆÁ±ªÂûã</label>
                    </div>
                </div>
            </div>

            <div class="card full-width">
                <h3><span class="icon">üöÄ</span>ÊîªÂáªÊâßË°å</h3>
                <div class="control-panel">
                    <button class="btn btn-primary" onclick="startAttack()">ÂºÄÂßãÂóÖÊé¢</button>
                    <button class="btn btn-warning" onclick="pauseAttack()">ÊöÇÂÅúÂóÖÊé¢</button>
                    <button class="btn btn-danger" onclick="stopAttack()">ÂÅúÊ≠¢ÂóÖÊé¢</button>
                    <button class="btn btn-success" onclick="exportResults()">ÂØºÂá∫ÁªìÊûú</button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="attackProgress"></div>
                </div>
            </div>
        </div>

        <div id="results" class="tab-content">
            <div class="card full-width">
                <h3><span class="icon">üìä</span>RTTÊµãÈáèÁªìÊûú</h3>
                <div class="results-grid" id="resultsGrid">
                    <!-- ÁªìÊûúÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>

            <div class="card full-width">
                <h3><span class="icon">üìà</span>RTTË∂ãÂäøÂõæ</h3>
                <canvas id="rttChart" width="800" height="300" style="max-width: 100%;"></canvas>
            </div>
        </div>

        <div id="analysis" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <h3><span class="icon">üîí</span>ÂÆâÂÖ®ÂàÜÊûê</h3>
                    <div id="securityAnalysis">
                        <h4>Ê£ÄÊµãÂà∞ÁöÑÂåπÈÖçÂüüÔºö</h4>
                        <ul id="detectedFields"></ul>
                        
                        <h4>ÂÆâÂÖ®È£éÈô©ËØÑ‰º∞Ôºö</h4>
                        <div id="riskAssessment"></div>
                        
                        <h4>Âª∫ËÆÆÈò≤Êä§Êé™ÊñΩÔºö</h4>
                        <ul id="recommendations"></ul>
                    </div>
                </div>

                <div class="card">
                    <h3><span class="icon">üìã</span>ÂÆûÈ™åÊä•Âëä</h3>
                    <div class="form-group">
                        <label class="form-label">Êä•ÂëäÊ†ºÂºè</label>
                        <select class="form-input" id="reportFormat">
                            <option value="html">HTMLÊä•Âëä</option>
                            <option value="json">JSONÊï∞ÊçÆ</option>
                        </select>
                        <p class="form-help">HTMLÊä•ÂëäÂåÖÂê´ÂõæË°®ÂíåÂÆåÊï¥ÂàÜÊûêÔºåJSONÊï∞ÊçÆÈÄÇÂêàËøõ‰∏ÄÊ≠•Â§ÑÁêÜ</p>
                    </div>
                    <button class="btn btn-primary full-width" onclick="generateReport()">
                        <span class="icon">üì•</span> ÁîüÊàêÂπ∂‰∏ãËΩΩÊä•Âëä
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let experimentState = {
            topologyRunning: false,
            attackRunning: false,
            results: {},
            logs: []
        };

        // Ê†áÁ≠æÈ°µÂàáÊç¢
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            event.target.classList.add('active');
            document.getElementById(tabName).style.display = 'block';
            if(tabName === 'results') {
                showResultCharts(experimentState.results);
            } else if(tabName === 'analysis') {
                analyzeResults(experimentState.results);
            }
        }

        // Êó•ÂøóËÆ∞ÂΩï
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span>${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ÊãìÊâëÁÆ°ÁêÜ
        function startTopology() {
            if (experimentState.topologyRunning) return;
            
            addLog('Ê≠£Âú®ÂêØÂä®SDNÊãìÊâëÁªìÊûÑ...', 'info');
            updateProgress('progress', 0);
            
            // ‰∏éÂêéÁ´ØAPIÈÄö‰ø°
            fetch('http://localhost:5000/api/start_topology', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ÊãìÊâëÂêØÂä®Â§±Ë¥•');
                }
                return response.json();
            })
            .then(data => {
                addLog('ÊãìÊâëÂêØÂä®ÊàêÂäüÔºÅ', 'success');
                experimentState.topologyRunning = true;
                document.getElementById('topo-status').className = 'status-indicator status-running';
                updateProgress('progress', 100);
            })
            .catch(error => {
                addLog(`ÈîôËØØ: ${error.message}`, 'error');
                updateProgress('progress', 0);
            });
        }

        function configFlows() {
            if (!experimentState.topologyRunning) {
                addLog('ËØ∑ÂÖàÂêØÂä®ÊãìÊâëÁªìÊûÑ', 'error');
                return;
            }
            addLog('ÈÖçÁΩÆÊµÅË°®ËßÑÂàô...', 'info');
            // Âä®ÊÄÅÊî∂ÈõÜÂãæÈÄâÁöÑÂåπÈÖçÂüü
            const checkedFields = Array.from(document.querySelectorAll('.field-checkbox:checked')).map(cb => cb.value);
            if (checkedFields.length === 0) {
                addLog('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÊµÅË°®ÂåπÈÖçÂüü', 'error');
                return;
            }
            fetch('http://localhost:5000/api/config_flows', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'fields': checkedFields
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ÊµÅË°®ÈÖçÁΩÆÂ§±Ë¥•');
                }
                return response.json();
            })
            .then(data => {
                addLog('ÊµÅË°®ËßÑÂàôÂ∑≤ÈÖçÁΩÆ', 'success');
            })
            .catch(error => {
                addLog(`ÈîôËØØ: ${error.message}`, 'error');
            });
        }

        function testConnectivity() {
            if (!experimentState.topologyRunning) {
                addLog('ËØ∑ÂÖàÂêØÂä®ÊãìÊâëÁªìÊûÑ', 'error');
                return;
            }
            
            addLog('ÊâßË°åËøûÈÄöÊÄßÊµãËØï...', 'info');
            
            fetch('http://localhost:5000/api/test_connectivity', {
                method: 'GET'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ËøûÈÄöÊÄßÊµãËØïÂ§±Ë¥•');
                }
                return response.json();
            })
            .then(data => {
                if (data.results) {
                    // Â§ÑÁêÜÂ≠óÂÖ∏Á±ªÂûãÁöÑÁªìÊûú
                    Object.keys(data.results).forEach(key => {
                        const rtt = data.results[key];
                        const [src, dst] = key.split('->');
                        if (rtt > 0) {
                            addLog(`${src} -> ${dst}: ËøûÈÄöÊ≠£Â∏∏ (${rtt.toFixed(2)}ms)`, 'success');
                        } else {
                            addLog(`${src} -> ${dst}: ËøûÈÄöÂ§±Ë¥•`, 'error');
                        }
                    });
                    addLog('ËøûÈÄöÊÄßÊµãËØïÂÆåÊàê', 'success');
                }
            })
            .catch(error => {
                addLog(`ÈîôËØØ: ${error.message}`, 'error');
            });
        }

        function stopTopology() {
            if (!experimentState.topologyRunning) return;
            
            addLog('Ê≠£Âú®ÂÅúÊ≠¢ÊãìÊâë...', 'warning');
            
            fetch('http://localhost:5000/api/stop_topology', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ÊãìÊâëÂÅúÊ≠¢Â§±Ë¥•');
                }
                return response.json();
            })
            .then(data => {
                experimentState.topologyRunning = false;
                document.getElementById('topo-status').className = 'status-indicator status-ready';
                updateProgress('progress', 0);
                addLog('ÊãìÊâëÂ∑≤ÂÅúÊ≠¢', 'info');
            })
            .catch(error => {
                addLog(`ÈîôËØØ: ${error.message}`, 'error');
            });
        }

        // ÊîªÂáªÊ®°Êãü
        function startAttack() {
            if (!experimentState.topologyRunning) {
                addLog('ËØ∑ÂÖàÂêØÂä®ÊãìÊâëÁªìÊûÑ', 'error');
                return;
            }
            if (experimentState.attackRunning) return;
            // Âä®ÊÄÅÊî∂ÈõÜÂãæÈÄâÁöÑÂåπÈÖçÂüü
            const checkedFields = Array.from(document.querySelectorAll('.field-checkbox:checked')).map(cb => cb.value);
            if (checkedFields.length === 0) {
                addLog('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÊµÅË°®ÂåπÈÖçÂüü', 'error');
                return;
            }
            addLog('ÂºÄÂßãÊâßË°åÂåπÈÖçÂüüÂóÖÊé¢ÊîªÂáª...', 'warning');
            fetch('http://localhost:5000/api/start_attack', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'fields': checkedFields
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ÊîªÂáªÂêØÂä®Â§±Ë¥•');
                }
                return response.json();
            })
            .then(data => {
                experimentState.attackRunning = true;
                addLog('ÊîªÂáªÂ∑≤ÂêØÂä®ÔºåÊ≠£Âú®Êî∂ÈõÜÊï∞ÊçÆ...', 'info');
                checkAttackStatus();
            })
            .catch(error => {
                addLog(`ÈîôËØØ: ${error.message}`, 'error');
            });
        }

        function checkAttackStatus() {
            fetch('http://localhost:5000/api/attack_status')
                .then(response => response.json())
                .then(data => {
                    if (data.completed) {
                        experimentState.attackRunning = false;
                        experimentState.results = data.results || {};
                        addLog('ÊîªÂáªÂÆåÊàêÔºåÊ≠£Âú®Â±ïÁ§∫ÁªìÊûú...', 'success');
                        showTab('results');
                        showResultCharts(experimentState.results);
                        analyzeResults(experimentState.results);
                    } else {
                        setTimeout(checkAttackStatus, 2000);  // ÁªßÁª≠ËΩÆËØ¢
                    }
                });
        }

        function generateResults() {
            addLog('Ê≠£Âú®ÁîüÊàêÂÆûÈ™åÊä•Âëä...', 'info');
            
            fetch('http://localhost:5000/api/generate_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ÁîüÊàêÊä•ÂëäÂ§±Ë¥•');
                }
                return response.json();
            })
            .then(data => {
                addLog('ÂÆûÈ™åÊä•ÂëäÁîüÊàêÊàêÂäü', 'success');
                
                if (data.report_url) {
                    const reportLink = document.getElementById('report-link');
                    reportLink.href = data.report_url;
                    reportLink.style.display = 'inline-block';
                }
                
                // ÊòæÁ§∫ÁªìÊûúÂõæË°®
                showResultCharts(data.results);
                
                // ÂÆâÂÖ®ÂàÜÊûê
                analyzeResults(data.results);
            })
            .catch(error => {
                addLog(`ÈîôËØØ: ${error.message}`, 'error');
            });
        }

        function analyzeResults(results) {
            const detectedFields = document.getElementById('detectedFields');
            const riskAssessment = document.getElementById('riskAssessment');
            const recommendations = document.getElementById('recommendations');
            
            detectedFields.innerHTML = '';
            
            // ‰ΩøÁî®‰º†ÂÖ•ÁöÑÁªìÊûúÊï∞ÊçÆÊàñÈªòËÆ§‰ΩøÁî®ÂÆûÈ™åÁä∂ÊÄÅ‰∏≠ÁöÑÁªìÊûú
            const resultsData = results || experimentState.results;
            const allAvg = Object.values(resultsData).map(d => d.avgRTT);
            const globalAvg = allAvg.length > 0 ? allAvg.reduce((a, b) => a + b, 0) / allAvg.length : 0;
            let detected = [];
            for (const [field, data] of Object.entries(resultsData)) {
                let reasons = [];
                if (data.variance > 1.0) reasons.push(`ÊñπÂ∑Æ${data.variance.toFixed(2)}ms > 1.0ms`);
                if (data.avgRTT > globalAvg * 1.5) reasons.push(`ÂùáÂÄº${data.avgRTT.toFixed(2)}ms > ÂÖ®ÈÉ®ÂùáÂÄºÁöÑ1.5ÂÄç(${(globalAvg*1.5).toFixed(2)}ms)`);
                if ((data.maxRTT - data.minRTT) > 5.0) reasons.push(`ÊûÅÂ∑Æ${(data.maxRTT-data.minRTT).toFixed(2)}ms > 5ms`);
                if (reasons.length > 0) {
                    const li = document.createElement('li');
                    li.textContent = `${field}: Ê£ÄÊµã‰∏∫ÂåπÈÖçÂüüÔºà${reasons.join('Ôºå')}Ôºâ`;
                    detectedFields.appendChild(li);
                    detected.push(field);
                }
            }
            let riskLevel = '';
            let riskDesc = '';
            if (detected.length >= 3) {
                riskLevel = '<div style="color: #e53e3e; font-weight: bold;">È´òÈ£éÈô©</div>';
                riskDesc = 'Ê£ÄÊµãÂà∞Â§ö‰∏™ÂåπÈÖçÂüüÂ≠òÂú®ÂèØËØÜÂà´ÁöÑRTTÂ∑ÆÂºÇÔºåÊîªÂáªËÄÖÂèØËÉΩÈÄöËøáÊ≠§ÊñπÊ≥ïÊé®Êñ≠ÁΩëÁªúÊµÅË°®ÈÖçÁΩÆ„ÄÇ';
            } else if (detected.length >= 1) {
                riskLevel = '<div style="color: #f6ad55; font-weight: bold;">‰∏≠È£éÈô©</div>';
                riskDesc = 'Ê£ÄÊµãÂà∞ÈÉ®ÂàÜÂåπÈÖçÂüüÂ≠òÂú®ÂèØËØÜÂà´ÁöÑRTTÂ∑ÆÂºÇÔºåÊîªÂáªËÄÖÂèØËÉΩÊé®Êñ≠ÈÉ®ÂàÜÊµÅË°®ÈÖçÁΩÆ„ÄÇ';
            } else {
                riskLevel = '<div style="color: #48bb78; font-weight: bold;">‰ΩéÈ£éÈô©</div>';
                riskDesc = 'Êú™Ê£ÄÊµãÂà∞ÊòéÊòæÁöÑÂåπÈÖçÂüüRTTÂ∑ÆÂºÇÔºåÂΩìÂâçÊµÅË°®ÈÖçÁΩÆÁõ∏ÂØπÂÆâÂÖ®„ÄÇ';
            }
            riskAssessment.innerHTML = `
                ${riskLevel}
                <p>${riskDesc}</p>
            `;
            recommendations.innerHTML = `
                <li>ÂÆûÊñΩÁªü‰∏ÄÁöÑÊï∞ÊçÆÂåÖÂ§ÑÁêÜÊó∂Èó¥</li>
                <li>Ê∑ªÂä†ÈöèÊú∫Âª∂Ëøü‰ª•Ê∑∑Ê∑ÜRTTÊ®°Âºè</li>
                <li>ÁõëÊéßÂºÇÂ∏∏Êé¢ÊµãË°å‰∏∫</li>
                <li>ÈôêÂà∂Âçï‰∏™Ê∫êÁöÑÊé¢ÊµãÈ¢ëÁéá</li>
                <li>‰ΩøÁî®Âä†ÂØÜÈÄöÈÅì‰øùÊä§ÊéßÂà∂‰ø°ÊÅØ</li>
            `;
        }

        function updateProgress(elementId, percent) {
            document.getElementById(elementId).style.width = percent + '%';
        }

        function showResultCharts(results) {
            const resultsContainer = document.getElementById('resultsGrid');
            resultsContainer.innerHTML = '';
            const allFields = ['eth_src', 'eth_dst', 'ip_src', 'ip_dst', 'tcp_src', 'tcp_dst', 'ip_proto'];
            const resultsData = results || experimentState.results;

            for (const field of allFields) {
                const data = resultsData[field];
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                if (data) {
                    resultCard.innerHTML = `
                        <div class="result-title">${field.toUpperCase()}</div>
                        <div class="rtt-value">${data.avgRTT.toFixed(2)}ms</div>
                        <div>ËåÉÂõ¥: ${data.minRTT.toFixed(2)}ms - ${data.maxRTT.toFixed(2)}ms</div>
                        <div>ÂèòÂåñ: ${data.variance.toFixed(2)}ms</div>
                    `;
                } else {
                    resultCard.innerHTML = `
                        <div class="result-title">${field.toUpperCase()}</div>
                        <div class="rtt-value">--</div>
                        <div>ËåÉÂõ¥: --</div>
                        <div>ÂèòÂåñ: --</div>
                    `;
                }
                resultsContainer.appendChild(resultCard);
            }
        }
        
        function pauseAttack() {
            if (experimentState.attackRunning) {
                fetch('http://localhost:5000/api/stop_attack', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'pause': true
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ÊöÇÂÅúÊîªÂáªÂ§±Ë¥•');
                    }
                    return response.json();
                })
                .then(data => {
                    experimentState.attackRunning = false;
                    addLog('ÊîªÂáªÂ∑≤ÊöÇÂÅú', 'warning');
                })
                .catch(error => {
                    addLog(`ÈîôËØØ: ${error.message}`, 'error');
                });
            }
        }

        function stopAttack() {
            if (!experimentState.attackRunning) return;
            
            fetch('http://localhost:5000/api/stop_attack', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ÂÅúÊ≠¢ÊîªÂáªÂ§±Ë¥•');
                }
                return response.json();
            })
            .then(data => {
                experimentState.attackRunning = false;
                updateProgress('attackProgress', 0);
                addLog('ÊîªÂáªÂ∑≤ÂÅúÊ≠¢', 'info');
            })
            .catch(error => {
                addLog(`ÈîôËØØ: ${error.message}`, 'error');
            });
        }

        function exportResults() {
            fetch('http://localhost:5000/api/export_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ÂØºÂá∫ÁªìÊûúÂ§±Ë¥•');
                }
                return response.json(); // ÂÖàÊãøÂà∞JSON
            })
            .then(data => {
                if (!data.download_url) {
                    throw new Error('ÊúçÂä°Âô®Êú™ËøîÂõû‰∏ãËΩΩÂú∞ÂùÄ');
                }
                // Á¨¨‰∫åÊ≠•Ôºöfetch‰∏ãËΩΩÊñá‰ª∂
                fetch(`http://localhost:5000${data.download_url}`)
                    .then(res => res.blob())
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.filename || 'sdn_attack_results.json';
                        a.click();
                        URL.revokeObjectURL(url);
                        addLog('ÂÆûÈ™åÁªìÊûúÂ∑≤ÂØºÂá∫', 'success');
                    });
            })
            .catch(error => {
                addLog(`ÈîôËØØ: ${error.message}`, 'error');
            });
        }

        function generateReport() {
            addLog('Ê≠£Âú®ÁîüÊàêÊä•Âëä...', 'info');
            
            // Ëé∑ÂèñÈÄâÊã©ÁöÑÊä•ÂëäÊ†ºÂºè
            const formatSelect = document.querySelector('#reportFormat');
            const format = formatSelect ? formatSelect.value.toLowerCase().replace('Êä•Âëä', '').replace('Êï∞ÊçÆ', '') : 'html';
            
            fetch('http://localhost:5000/api/generate_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    format: format
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ÁîüÊàêÊä•ÂëäÂ§±Ë¥•');
                }
                return response.json();
            })
            .then(data => {
                if (!data.download_url) {
                    throw new Error('ÊúçÂä°Âô®Êú™ËøîÂõû‰∏ãËΩΩÂú∞ÂùÄ');
                }
                
                // ‰∏ãËΩΩÊñá‰ª∂
                fetch(`http://localhost:5000${data.download_url}`)
                    .then(res => res.blob())
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.filename || 'sdn_security_report.html';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        addLog('Êä•ÂëäÁîüÊàêÂπ∂‰∏ãËΩΩÊàêÂäü', 'success');
                    });
            })
            .catch(error => {
                addLog(`ÈîôËØØ: ${error.message}`, 'error');
            });
        }

        // ÁΩëÁªúËäÇÁÇπ‰∫§‰∫í
        document.addEventListener('DOMContentLoaded', function() {
            const nodes = document.querySelectorAll('.node');
            nodes.forEach(node => {
                node.addEventListener('click', function() {
                    const nodeName = this.getAttribute('data-name');
                    showNodeInfo(nodeName);
                });
            });
        });

        function showNodeInfo(nodeName) {
            const nodeInfo = {
                's1': {
                    type: '‰∫§Êç¢Êú∫',
                    ip: 'ÁÆ°ÁêÜIP: 192.168.1.10',
                    ports: 'Á´ØÂè£: 4‰∏™',
                    flows: 'ÊµÅË°®ËßÑÂàô: Âü∫‰∫éÊ∫êIPÂåπÈÖç'
                },
                's2': {
                    type: '‰∫§Êç¢Êú∫',
                    ip: 'ÁÆ°ÁêÜIP: 192.168.1.11',
                    ports: 'Á´ØÂè£: 4‰∏™',
                    flows: 'ÊµÅË°®ËßÑÂàô: Âü∫‰∫éÁõÆÊ†áÁ´ØÂè£ÂåπÈÖç'
                },
                'c1': {
                    type: 'OpenFlowÊéßÂà∂Âô®',
                    ip: 'ÊéßÂà∂IP: 192.168.1.1',
                    version: 'OpenFlow 1.3',
                    status: 'ËøêË°å‰∏≠'
                },
                'h1': {
                    type: '‰∏ªÊú∫',
                    ip: 'IP: 10.0.0.1',
                    mac: 'MAC: 00:00:00:00:00:01',
                    role: 'ÊîªÂáªÊ∫ê'
                },
                'h2': {
                    type: '‰∏ªÊú∫',
                    ip: 'IP: 10.0.0.2',
                    mac: 'MAC: 00:00:00:00:00:02',
                    role: 'ÊîªÂáªÁõÆÊ†á'
                },
                'h3': {
                    type: '‰∏ªÊú∫',
                    ip: 'IP: 10.0.0.3',
                    mac: 'MAC: 00:00:00:00:00:03',
                    role: 'ËßÇÂØüËäÇÁÇπ'
                },
                'h4': {
                    type: '‰∏ªÊú∫',
                    ip: 'IP: 10.0.0.4',
                    mac: 'MAC: 00:00:00:00:00:04',
                    role: 'ËßÇÂØüËäÇÁÇπ'
                }
            };
            
            const info = nodeInfo[nodeName];
            if (info) {
                addLog(`ËäÇÁÇπ‰ø°ÊÅØ - ${nodeName.toUpperCase()}: ${info.type}, ${info.ip || info.mac}`, 'info');
            }
        }

        // RTTÂõæË°®ÁªòÂà∂
        function drawRTTChart() {
            const canvas = document.getElementById('rttChart');
            const ctx = canvas.getContext('2d');
            const allFields = ['eth_src', 'eth_dst', 'ip_src', 'ip_dst', 'tcp_src', 'tcp_dst', 'ip_proto'];
            const resultsData = experimentState.results;

            // Ê∏ÖÁ©∫ÁîªÂ∏É
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Ê≤°Êúâ‰ªª‰ΩïÊï∞ÊçÆ
            if (Object.keys(resultsData).length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑ÂÖàÊâßË°åÊîªÂáª', canvas.width/2, canvas.height/2);
                return;
            }

            // ÁªÑË£ÖÊâÄÊúâÊü±Â≠êÊï∞ÊçÆ
            let bars = [];
            let maxRTT = 0;
            allFields.forEach((field, idx) => {
                const data = resultsData[field];
                if (data && data.samples.length > 0) {
                    data.samples.forEach((rtt, i) => {
                        bars.push({
                            field,
                            idx,
                            rtt,
                            sampleIdx: i
                        });
                        if (rtt > maxRTT) maxRTT = rtt;
                    });
                }
            });
            if (maxRTT === 0) maxRTT = 1;

            // Êü±Áä∂ÂõæÂèÇÊï∞
            const barWidth = Math.max(8, (canvas.width - 100) / bars.length - 2);
            const colors = ['#667eea', '#e53e3e', '#38a169', '#f6ad55', '#3182ce', '#d53f8c', '#319795'];

            // ÂùêÊ†áËΩ¥
            ctx.strokeStyle = '#888';
            ctx.lineWidth = 1;
                ctx.beginPath();
            ctx.moveTo(60, 20);
            ctx.lineTo(60, canvas.height - 40);
            ctx.lineTo(canvas.width - 20, canvas.height - 40);
                ctx.stroke();

            // YËΩ¥ÂàªÂ∫¶
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            for (let i = 0; i <= 5; i++) {
                const y = canvas.height - 40 - (canvas.height - 80) * (i / 5);
                const rttVal = (maxRTT * i / 5).toFixed(0);
                ctx.fillText(rttVal + 'ms', 10, y + 4);
            }

            // ÁîªÊü±Â≠ê
            bars.forEach((bar, i) => {
                const x = 60 + i * (barWidth + 2);
                const y = canvas.height - 40 - (canvas.height - 80) * (bar.rtt / maxRTT);
                const h = (canvas.height - 40) - y;
                ctx.fillStyle = colors[bar.idx % colors.length];
                ctx.fillRect(x, y, barWidth, h);

                // Ê®™ËΩ¥Ê†áÁ≠æÔºàÂè™ÁîªÁ¨¨‰∏Ä‰∏™Ê†∑Êú¨Êó∂ÁöÑÂ≠óÊÆµÂêçÔºâ
                if (bar.sampleIdx === 0) {
                    ctx.save();
                    ctx.translate(x + barWidth / 2, canvas.height - 25);
                    ctx.rotate(-Math.PI / 4);
                    ctx.textAlign = 'right';
                    ctx.fillStyle = colors[bar.idx % colors.length];
                    ctx.font = '12px Arial';
                    ctx.fillText(bar.field.toUpperCase(), 0, 0);
                    ctx.restore();
                }
            });

            // Âõæ‰æã
            allFields.forEach((field, idx) => {
                ctx.fillStyle = colors[idx % colors.length];
                ctx.fillRect(canvas.width - 110, 30 + idx * 18, 14, 14);
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.fillText(field.toUpperCase(), canvas.width - 90, 42 + idx * 18);
            });
        }

        // ÂÆûÊó∂Êõ¥Êñ∞ÂõæË°®
        setInterval(() => {
            if (document.getElementById('results').style.display !== 'none') {
                drawRTTChart();
            }
        }, 1000);

        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey) {
                switch(event.key) {
                    case '1':
                        event.preventDefault();
                        showTab('topology');
                        break;
                    case '2':
                        event.preventDefault();
                        showTab('attack');
                        break;
                    case '3':
                        event.preventDefault();
                        showTab('results');
                        break;
                    case '4':
                        event.preventDefault();
                        showTab('analysis');
                        break;
                    case 's':
                        event.preventDefault();
                        if (experimentState.topologyRunning) {
                            startAttack();
                        } else {
                            startTopology();
                        }
                        break;
                }
            }
        });

        // ÂàùÂßãÂåñÊèêÁ§∫
        addLog('SDNÂåπÈÖçÂüüÂóÖÊé¢ÊîªÂáªÂÆûÈ™åÂπ≥Âè∞Â∑≤Â∞±Áª™', 'success');
        addLog('Âø´Êç∑ÈîÆ: Ctrl+1-4 ÂàáÊç¢Ê†áÁ≠æÈ°µ, Ctrl+S ÂºÄÂßã', 'info');
        addLog('ËΩØ‰ª∂ÂÆö‰πâÁΩëÁªúËØæÁ®ãËÆæËÆ°', 'warning');
    </script>
</body>
</html>